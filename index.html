<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ•¸å­¸ç‰¹è¨“ï¼šç›´å¼æ‹†è§£ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto+Mono:wght@500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f0f9ff;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        
        /* éš±è— Input çš„ç®­é ­ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* ç›´å¼æ ¼ç·šè¨­è¨ˆ */
        .digit-input {
            width: 100%;
            height: 100%;
            text-align: center;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: white;
            transition: all 0.2s;
            color: #1e293b;
        }
        .digit-input:focus {
            border-color: #6366f1;
            outline: none;
            background-color: #eef2ff;
            transform: scale(1.05);
        }
        /* é€²ä½/é€€ä½æ ¼ */
        .carry-input {
            width: 100%;
            height: 30px;
            text-align: center;
            font-size: 0.9rem;
            color: #ef4444; /* ç´…è‰²å­— */
            background-color: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 4px;
        }
        .calc-line {
            height: 4px;
            background-color: #1e293b;
            border-radius: 2px;
            margin-top: 4px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon ---
        const Icon = {
            Clock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Refresh: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>,
            ArrowRight: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        };

        // --- ç›´å¼è¼¸å…¥çµ„ä»¶ (æ ¸å¿ƒ) ---
        const VerticalGrid = ({ n1, n2, op, onComplete }) => {
            // å°‡æ•¸å­—æ‹†è§£ç‚ºé™£åˆ— (è£œæ»¿ 4 ä½æ•¸ä»¥ä¾¿å°é½Š)
            const digits1 = n1.toString().padStart(4, ' ').split('');
            const digits2 = n2.toString().padStart(4, ' ').split('');
            
            // ç”¨æˆ¶è¼¸å…¥ç‹€æ…‹ï¼š4å€‹ä¸»ç­”æ¡ˆæ ¼ï¼Œ4å€‹é€²ä½/é€€ä½æ ¼
            const [inputs, setInputs] = useState(['', '', '', '']); 
            const [carries, setCarries] = useState(['', '', '', '']);
            const [errorMsg, setErrorMsg] = useState('');

            const correctAns = op === '+' ? n1 + n2 : n1 - n2;
            const correctDigits = correctAns.toString().padStart(4, ' ').split('');

            const handleInputChange = (index, value, type) => {
                if (type === 'main') {
                    const newInputs = [...inputs];
                    newInputs[index] = value.slice(-1); // åªç•™æœ€å¾Œä¸€ä½
                    setInputs(newInputs);
                } else {
                    const newCarries = [...carries];
                    newCarries[index] = value.slice(-2); // å…è¨±å…©ä½ (ä¾‹å¦‚é€€ä½å¾Œå‰© 12)
                    setCarries(newCarries);
                }
                setErrorMsg('');
            };

            const checkAnswer = () => {
                // æª¢æŸ¥é‚è¼¯ï¼šå°‡ inputs çµ„åˆèµ·ä¾†ï¼ŒparseInt å¾Œæ˜¯å¦ç­‰æ–¼ç­”æ¡ˆ
                // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘å…è¨±å‰é¢çš„ç©ºæ ¼æ˜¯ç©ºçš„
                let userNumStr = "";
                inputs.forEach(d => {
                    if(d === '') userNumStr += " "; // ä¿æŒç©ºæ ¼ä½ç½®
                    else userNumStr += d;
                });
                
                const userNum = parseInt(userNumStr.replace(/\s/g, '')); // å»æ‰ç©ºæ ¼è½‰æ•¸å­—
                
                if (userNum === correctAns) {
                    onComplete(correctAns);
                } else {
                    setErrorMsg('ç­”æ¡ˆä¸å°å–”ï¼è«‹æª¢æŸ¥é€²ä½æˆ–é€€ä½ã€‚');
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm mx-auto max-w-sm animate-in zoom-in-95 duration-300">
                    <div className="grid grid-cols-5 gap-2 font-mono">
                        {/* 0. é€²ä½/é€€ä½æç¤ºè¡Œ (Row 0) */}
                        <div className="col-span-1"></div>
                        {carries.map((val, i) => (
                            <input key={`c-${i}`} 
                                type="text"
                                className="carry-input"
                                placeholder="."
                                value={val}
                                onChange={(e) => handleInputChange(i, e.target.value, 'carry')}
                            />
                        ))}

                        {/* 1. ç¬¬ä¸€å€‹æ•¸å­— (Row 1) */}
                        <div className="col-span-1"></div>
                        {digits1.map((d, i) => (
                            <div key={`d1-${i}`} className="h-12 flex items-center justify-center text-3xl font-black text-slate-700">
                                {d}
                            </div>
                        ))}

                        {/* 2. é‹ç®—ç¬¦ + ç¬¬äºŒå€‹æ•¸å­— (Row 2) */}
                        <div className="col-span-1 flex items-center justify-center text-3xl font-black text-slate-500">{op}</div>
                        {digits2.map((d, i) => (
                            <div key={`d2-${i}`} className="h-12 flex items-center justify-center text-3xl font-black text-slate-700">
                                {d}
                            </div>
                        ))}

                        {/* 3. åˆ†éš”ç·š */}
                        <div className="col-span-5 calc-line"></div>

                        {/* 4. ç­”æ¡ˆè¼¸å…¥è¡Œ (Row 3) - é€™è£¡éœ€è¦ Jasper å¡«å¯« */}
                        <div className="col-span-1"></div>
                        {inputs.map((val, i) => (
                            <div key={`in-${i}`} className="h-16">
                                <input 
                                    type="number" 
                                    className={`digit-input ${val !== '' && correctDigits[i] !== ' ' && parseInt(val) !== parseInt(correctDigits[i]) ? 'border-red-400 bg-red-50 text-red-600' : ''}`}
                                    value={val}
                                    placeholder={correctDigits[i] === ' ' ? '' : '?'}
                                    disabled={correctDigits[i] === ' '} // ä¸éœ€è¦å¡«çš„ä½ç½®é–ä½
                                    onChange={(e) => handleInputChange(i, e.target.value, 'main')}
                                />
                            </div>
                        ))}
                    </div>

                    {errorMsg && (
                        <div className="mt-4 text-center text-rose-500 font-bold bg-rose-50 p-2 rounded-lg text-sm">
                            {errorMsg}
                        </div>
                    )}

                    <button onClick={checkAnswer} className="mt-6 w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-black rounded-xl shadow-lg active:scale-95 transition-all">
                        æª¢æŸ¥ç›´å¼
                    </button>
                    <p className="text-center text-xs text-slate-400 mt-2">æç¤ºï¼šä¸Šæ–¹çš„è™›ç·šæ ¼å¯ç”¨ä¾†å¯«é€²ä½æˆ–é€€ä½</p>
                </div>
            );
        };

        // --- ä¸»ç¨‹å¼é‚è¼¯ ---
        const App = () => {
            const [gameState, setGameState] = useState('menu'); // menu, playing, result
            const [currentQ, setCurrentQ] = useState(null);
            const [stageIndex, setStageIndex] = useState(0); // é¡Œç›®å…§éƒ¨çš„éšæ®µ (é‚è¼¯ -> ç›´å¼1 -> ç›´å¼2)
            const [qIndex, setQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [history, setHistory] = useState([]);
            const [timer, setTimer] = useState(0);
            const timerRef = useRef(null);

            const TOTAL_QUESTIONS = 5; // ç¤ºç¯„ç”¨ 5 é¡Œ

            // è¨ˆæ™‚å™¨é‚è¼¯
            useEffect(() => {
                if (gameState === 'playing') {
                    timerRef.current = setInterval(() => setTimer(t => t + 1), 1000);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [gameState]);

            // --- é¡Œç›®ç”Ÿæˆå™¨ (æ ¸å¿ƒé‡æ§‹) ---
            const generateQuestion = () => {
                const types = ['BRACKET_MIXED', 'CONTINUOUS_OP'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                let qData = {
                    id: Date.now(),
                    type: type,
                    text: '',
                    stages: [] // é€™è£¡å­˜æ”¾é¡Œç›®çš„æ¯ä¸€å€‹ã€Œæ­¥é©Ÿã€
                };

                if (type === 'BRACKET_MIXED') {
                    // é¡Œå‹ï¼š35 - (13 + 8) æˆ– (20 - 5) * 4 (åªåšåŠ æ¸›ç¤ºç¯„)
                    // è¨­å®šï¼š A - (B + C)
                    const B = Math.floor(Math.random() * 20) + 10;
                    const C = Math.floor(Math.random() * 9) + 1;
                    const sumBC = B + C;
                    const A = sumBC + Math.floor(Math.random() * 20) + 10; // ç¢ºä¿ A > B+C

                    qData.text = `${A} - (${B} + ${C}) = ?`;
                    
                    // Stage 1: é‚è¼¯é¸æ“‡
                    qData.stages.push({
                        type: 'LOGIC',
                        question: 'é€™é¡Œè¦å…ˆè¨ˆç®—å“ªéƒ¨åˆ†ï¼Ÿ',
                        options: [`${A} - ${B}`, `${B} + ${C}`, `${A} + ${C}`],
                        correctOpt: `${B} + ${C}`
                    });

                    // Stage 2: ç›´å¼è¨ˆç®— (æ‹¬å¼§å…§)
                    qData.stages.push({
                        type: 'VERTICAL',
                        hint: `å…ˆè¨ˆç®—æ‹¬å¼§å…§çš„ï¼š${B} + ${C}`,
                        n1: B, n2: C, op: '+', result: sumBC
                    });

                    // Stage 3: ç›´å¼è¨ˆç®— (æ‹¬å¼§å¤–)
                    qData.stages.push({
                        type: 'VERTICAL',
                        hint: `ç¾åœ¨ç”¨ ${A} æ¸›å»å‰›æ‰çš„ç­”æ¡ˆ (${sumBC})`,
                        n1: A, n2: sumBC, op: '-', result: A - sumBC
                    });

                } else {
                    // é¡Œå‹ï¼š2205 + 2154 - 423 (é€£çºŒé‹ç®—)
                    // æ‹†è§£ï¼š (A + B) - C
                    const A = Math.floor(Math.random() * 2000) + 1000;
                    const B = Math.floor(Math.random() * 2000) + 500;
                    const sumAB = A + B;
                    const C = Math.floor(Math.random() * 500) + 100;

                    qData.text = `${A} + ${B} - ${C} = ?`;

                    // Stage 1: ç›´å¼è¨ˆç®— (å‰å…©æ•¸)
                    qData.stages.push({
                        type: 'VERTICAL',
                        hint: `ç¬¬ä¸€æ­¥ï¼šå…ˆè¨ˆç®—å‰é¢å…©å€‹æ•¸ç›¸åŠ `,
                        n1: A, n2: B, op: '+', result: sumAB
                    });

                    // Stage 2: ç›´å¼è¨ˆç®— (æ¸›ç¬¬ä¸‰æ•¸)
                    qData.stages.push({
                        type: 'VERTICAL',
                        hint: `ç¬¬äºŒæ­¥ï¼šç”¨å‰›æ‰çš„ç­”æ¡ˆ (${sumAB}) æ¸›å» ${C}`,
                        n1: sumAB, n2: C, op: '-', result: sumAB - C
                    });
                }

                return qData;
            };

            const startGame = () => {
                setScore(0);
                setHistory([]);
                setTimer(0);
                setQIndex(0);
                loadNextQuestion();
                setGameState('playing');
            };

            const loadNextQuestion = () => {
                const newQ = generateQuestion();
                setCurrentQ(newQ);
                setStageIndex(0);
            };

            const handleStageComplete = (userAnswer, isCorrectLogic = true) => {
                // è¨˜éŒ„æ­·ç¨‹
                if (!isCorrectLogic) {
                    setHistory([...history, { 
                        text: currentQ.text, 
                        errorType: 'é‚è¼¯éŒ¯èª¤', 
                        detail: 'æ²’æœ‰å…ˆç®—æ‹¬å¼§' 
                    }]);
                    return; // é‚è¼¯é¡ŒéŒ¯äº†ä¸å‰é€²
                }

                // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹ Stage
                if (stageIndex >= currentQ.stages.length - 1) {
                    setScore(s => s + 1);
                    if (qIndex < TOTAL_QUESTIONS - 1) {
                        setQIndex(q => q + 1);
                        loadNextQuestion();
                    } else {
                        setGameState('result');
                    }
                } else {
                    // é€²å…¥ä¸‹ä¸€å€‹ Stage
                    setStageIndex(prev => prev + 1);
                }
            };

            // --- æ¸²æŸ“ ---

            if (gameState === 'menu') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl max-w-md w-full text-center border border-slate-100">
                            <h1 className="text-3xl font-black text-slate-800 mb-2">Jasper æ•¸å­¸ç‰¹è¨“</h1>
                            <p className="text-indigo-500 font-bold mb-8">åˆ†æ­¥ç›´å¼æŒ‘æˆ° V2.0</p>
                            <div className="bg-indigo-50 p-6 rounded-2xl text-left text-slate-600 mb-8 space-y-3">
                                <p>ğŸ¯ <span className="font-bold text-slate-800">ç›®æ¨™ï¼š</span> ä¸ç”¨å¿ƒç®—ï¼Œç”¨ç›´å¼ä¸€æ­¥æ­¥ç®—ã€‚</p>
                                <p>âœï¸ <span className="font-bold text-slate-800">å·¥å…·ï¼š</span> ä½¿ç”¨ä¸Šæ–¹çš„å°æ ¼å­è¨˜ä¸‹é€²ä½/é€€ä½ã€‚</p>
                            </div>
                            <button onClick={startGame} className="w-full bg-indigo-600 text-white text-xl font-black py-4 rounded-2xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                                é–‹å§‹æŒ‘æˆ°
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'result') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl max-w-lg w-full text-center border border-slate-100">
                            <h2 className="text-4xl font-black text-slate-800 mb-4">æŒ‘æˆ°å®Œæˆï¼</h2>
                            
                            <div className="flex justify-center gap-6 mb-8">
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                    <div className="text-xs font-black text-slate-400 uppercase">ç¸½å¾—åˆ†</div>
                                    <div className="text-4xl font-black text-indigo-600">{Math.round((score/TOTAL_QUESTIONS)*100)}%</div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                    <div className="text-xs font-black text-slate-400 uppercase">ç¸½æ™‚é–“</div>
                                    <div className="text-4xl font-black text-slate-800">{timer}s</div>
                                </div>
                            </div>

                            {history.length > 0 ? (
                                <div className="text-left mb-8 max-h-60 overflow-y-auto custom-scrollbar bg-rose-50 p-4 rounded-2xl border border-rose-100">
                                    <h3 className="font-bold text-rose-600 mb-2">éŒ¯é¡Œå›é¡§ï¼š</h3>
                                    {history.map((h, i) => (
                                        <div key={i} className="mb-2 pb-2 border-b border-rose-200 last:border-0">
                                            <div className="font-mono font-bold text-slate-700">{h.text}</div>
                                            <div className="text-sm text-rose-500">åŸå› ï¼š{h.detail}</div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="bg-green-50 p-6 rounded-2xl border border-green-200 text-green-700 font-bold mb-8">
                                    å¤ªæ£’äº†ï¼å…¨å°ï¼è¨˜å¾—ä¿æŒå¯«ç›´å¼çš„å¥½ç¿’æ…£ï¼ğŸŒŸ
                                </div>
                            )}

                            <button onClick={startGame} className="w-full flex items-center justify-center gap-2 bg-slate-800 text-white text-xl font-black py-4 rounded-2xl shadow-lg hover:bg-slate-700 active:scale-95 transition-all">
                                <Icon.Refresh /> å†è©¦ä¸€æ¬¡
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Playing State ---
            const currentStage = currentQ.stages[stageIndex];
            const progress = ((qIndex) / TOTAL_QUESTIONS) * 100;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-2xl mx-auto">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-slate-100">
                            <Icon.Clock /> <span className="font-mono font-bold text-lg">{timer}s</span>
                        </div>
                        <div className="font-black text-slate-400">
                            Q {qIndex + 1} / {TOTAL_QUESTIONS}
                        </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="h-2 bg-slate-200 rounded-full mb-8 overflow-hidden">
                        <div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${progress}%`}}></div>
                    </div>

                    {/* Question Card */}
                    <div className="bg-white rounded-[2.5rem] shadow-lg border border-slate-200 overflow-hidden">
                        <div className="bg-slate-50 p-8 text-center border-b border-slate-100">
                            <h2 className="text-3xl font-mono font-black text-slate-800">{currentQ.text}</h2>
                        </div>

                        <div className="p-8">
                            {/* éšæ®µæç¤º */}
                            <div className="mb-6 flex items-center justify-center gap-2">
                                <span className="bg-indigo-100 text-indigo-700 text-xs font-black px-3 py-1 rounded-full uppercase tracking-widest">
                                    STEP {stageIndex + 1}
                                </span>
                                <span className="font-bold text-slate-600">
                                    {currentStage.type === 'LOGIC' ? currentStage.question : currentStage.hint}
                                </span>
                            </div>

                            {/* å…§å®¹å€åŸŸï¼šæ ¹æ“š Stage é¡å‹åˆ‡æ› */}
                            {currentStage.type === 'LOGIC' && (
                                <div className="grid gap-4 max-w-sm mx-auto animate-in slide-in-from-right duration-300">
                                    {currentStage.options.map((opt, i) => (
                                        <button 
                                            key={i}
                                            onClick={() => {
                                                if (opt === currentStage.correctOpt) {
                                                    handleStageComplete(opt, true);
                                                } else {
                                                    handleStageComplete(opt, false);
                                                    alert('ä¸å°å–”ï¼æƒ³ä¸€æƒ³é‹ç®—é †åºï¼Œæœ‰æ‹¬å¼§è¦å…ˆç®—ï¼Ÿ');
                                                }
                                            }}
                                            className="p-5 border-2 border-slate-200 rounded-2xl text-xl font-bold text-slate-700 hover:border-indigo-500 hover:bg-indigo-50 hover:text-indigo-700 transition-all text-center"
                                        >
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {currentStage.type === 'VERTICAL' && (
                                <VerticalGrid 
                                    key={`${currentQ.id}-s${stageIndex}`} // ç¢ºä¿åˆ‡æ›æ­¥é©Ÿæ™‚é‡ç½® Grid
                                    n1={currentStage.n1} 
                                    n2={currentStage.n2} 
                                    op={currentStage.op}
                                    onComplete={() => handleStageComplete(null, true)}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
