<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper å°ä¸‰æ•¸å­¸æ¨¡æ“¬è©¦å· (V5.0 é€²éšå›é¥‹ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto+Mono:wght@500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f9ff; user-select: none; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .digit-input { width: 100%; height: 100%; text-align: center; font-family: 'Roboto Mono', monospace; font-weight: 700; font-size: 1.5rem; border: 2px solid #cbd5e1; border-radius: 0.5rem; background-color: white; color: #1e293b; transition: all 0.2s; }
        .digit-input:focus { border-color: #6366f1; outline: none; background-color: #eef2ff; transform: scale(1.05); z-index: 10; }
        .digit-input:disabled { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
        .carry-input { width: 100%; height: 32px; text-align: center; font-size: 1rem; font-weight: bold; color: #ef4444; background-color: #fff1f2; border: 1px dashed #fda4af; border-radius: 4px; }
        .calc-line { height: 4px; background-color: #334155; border-radius: 2px; margin-top: 4px; margin-bottom: 4px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* é¼“å‹µå‹•ç•« */
        @keyframes popUp {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .praise-anim { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = {
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Calc: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Star: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg>,
            Redo: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>
        };

        const PRAISE_WORDS = ["å¤ªæ£’äº†ï¼", "Jasper å¥½é‡ï¼", "å®Œå…¨æ­£ç¢ºï¼", "åšå¾—å¥½ï¼", "æ•¸å­¸å¤©æ‰ï¼", "ç¹¼çºŒåŠ æ²¹ï¼", "ç„¡å¾—é ‚ï¼"];

        // --- çµ„ä»¶ï¼šç›´å¼åŠ æ¸› ---
        const VerticalAddSub = ({ n1, n2, op, onComplete }) => {
            const digits1 = n1.toString().padStart(4, ' ').split('');
            const digits2 = n2.toString().padStart(4, ' ').split('');
            const [inputs, setInputs] = useState(['', '', '', '']);
            const [carries, setCarries] = useState(['', '', '', '']);
            const [errorMsg, setErrorMsg] = useState('');
            const correctAns = op === '+' ? n1 + n2 : n1 - n2;
            const correctDigits = correctAns.toString().padStart(4, ' ').split('');

            const checkAnswer = () => {
                let userNumStr = inputs.map(d => d === '' ? ' ' : d).join('');
                if (parseInt(userNumStr.replace(/\s/g, '')) === correctAns) {
                    onComplete(correctAns);
                } else {
                    setErrorMsg('å°å¿ƒï¼è«‹æª¢æŸ¥ä½ çš„ç­”æ¡ˆå’Œé€²ä½/é€€ä½ã€‚');
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-sm mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-5 gap-2 font-mono">
                        <div className="col-span-1"></div>
                        {carries.map((v, i) => <input key={i} className="carry-input" value={v} placeholder="." onChange={e=>setCarries(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} />)}
                        <div className="col-span-1"></div>
                        {digits1.map((d, i) => <div key={i} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-3xl font-black text-slate-400">{op}</div>
                        {digits2.map((d, i) => <div key={i} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-5 calc-line"></div>
                        <div className="col-span-1"></div>
                        {inputs.map((v, i) => (
                            <input key={i} type="number" className={`digit-input ${v!=='' && correctDigits[i]!==' ' && v!==correctDigits[i] ? 'bg-red-50 border-red-300 text-red-600' : ''}`} value={v} disabled={correctDigits[i]===' '} onChange={e => {setInputs(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />
                        ))}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all">æª¢æŸ¥ç­”æ¡ˆ</button>
                </div>
            );
        };

        // --- çµ„ä»¶ï¼šç›´å¼ä¹˜æ³• ---
        const VerticalMulti = ({ n1, n2, onComplete }) => {
            const digits1 = n1.toString().padStart(3, ' ').split('');
            const [inputs, setInputs] = useState(['', '', '', '']);
            const [carries, setCarries] = useState(['', '', '']);
            const [errorMsg, setErrorMsg] = useState('');
            const correctAns = n1 * n2;
            const correctDigits = correctAns.toString().padStart(4, ' ').split('');

            const checkAnswer = () => {
                let userNumStr = inputs.map(d => d === '' ? ' ' : d).join('');
                if (parseInt(userNumStr.replace(/\s/g, '')) === correctAns) {
                    onComplete(correctAns);
                } else {
                    setErrorMsg('ä¹˜æ³•ç®—éŒ¯å›‰ï¼è¨˜å¾—æŠŠé€²ä½å¯«åœ¨ä¸Šé¢ã€‚');
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-sm mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-5 gap-2 font-mono">
                        <div className="col-span-2"></div>
                        {carries.map((v, i) => <input key={i} className="carry-input" placeholder="é€²" value={v} onChange={e=>setCarries(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;})} />)}
                        <div className="col-span-2"></div>
                        {digits1.map((d, i) => <div key={i} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-right text-3xl font-black text-slate-400 mr-2">Ã—</div>
                        <div className="col-span-3"></div>
                        <div className="col-span-1 h-10 flex items-center justify-center text-3xl font-black text-slate-700">{n2}</div>
                        <div className="col-span-5 calc-line"></div>
                        <div className="col-span-1"></div>
                        {inputs.map((v, i) => (
                            <input key={i} type="number" className={`digit-input ${v!=='' && correctDigits[i]!==' ' && v!==correctDigits[i] ? 'bg-red-50 border-red-300 text-red-600' : ''}`} value={v} disabled={correctDigits[i]===' '} placeholder={correctDigits[i]===' '?'':'?'} onChange={e => {setInputs(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />
                        ))}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all">æª¢æŸ¥ç­”æ¡ˆ</button>
                    <p className="text-xs text-center text-slate-400 mt-2">æç¤ºï¼šé€²ä½çš„å°æ•¸å­—å¯«åœ¨æœ€ä¸Šé¢</p>
                </div>
            );
        };

        // --- çµ„ä»¶ï¼šæ™‚é˜ ---
        const ClockFace = ({ h, m, interactive, onTimeChange, onConfirm }) => {
            const hourAngle = (h * 30) + (m * 0.5);
            const minuteAngle = m * 6;
            const handleHour = () => interactive && onTimeChange(h===12?1:h+1, m);
            const handleMin = () => interactive && onTimeChange(h, m===0?30:0);

            return (
                <div className="flex flex-col items-center">
                    <svg width="180" height="180" viewBox="0 0 200 200" className="drop-shadow-lg my-4">
                        <circle cx="100" cy="100" r="95" fill="white" stroke="#334155" strokeWidth="6" />
                        {[...Array(12)].map((_, i) => <text key={i} x={100+75*Math.sin((i+1)*Math.PI/6)} y={105-75*Math.cos((i+1)*Math.PI/6)} textAnchor="middle" className="font-bold text-lg font-mono" fill="#64748b">{i+1}</text>)}
                        <line x1="100" y1="100" x2={100+50*Math.sin(hourAngle*Math.PI/180)} y2={100-50*Math.cos(hourAngle*Math.PI/180)} stroke="#1e293b" strokeWidth="6" strokeLinecap="round" />
                        <line x1="100" y1="100" x2={100+75*Math.sin(minuteAngle*Math.PI/180)} y2={100-75*Math.cos(minuteAngle*Math.PI/180)} stroke="#ef4444" strokeWidth="4" strokeLinecap="round" />
                        <circle cx="100" cy="100" r="5" fill="#1e293b" />
                    </svg>
                    {interactive && (
                        <div className="flex flex-col w-full gap-3">
                            <div className="flex gap-2 justify-center">
                                <button onClick={handleHour} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-bold shadow hover:bg-slate-300">èª¿æ™‚é‡</button>
                                <button onClick={handleMin} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-bold shadow hover:bg-slate-300">èª¿åˆ†é‡</button>
                            </div>
                            <button onClick={onConfirm} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all">ç¢ºèªæ™‚é–“</button>
                        </div>
                    )}
                </div>
            );
        };

        // --- çµ„ä»¶ï¼šå¹¾ä½•åœ–å½¢ ---
        const GeometryView = ({ type }) => (
            <div className="flex justify-center my-4">
                 <svg width="200" height="150" viewBox="0 0 200 150">
                    {type === 'trapezoid' && (
                        <><path d="M40 130 L160 130 L140 20 L60 20 Z" fill="none" stroke="#334155" strokeWidth="4" /><path d="M60 20 L100 130 L140 20 Z" fill="#e0e7ff" stroke="#4f46e5" strokeWidth="3" strokeDasharray="5,5" /></>
                    )}
                    {type === 'triangle' && <path d="M50 130 L150 130 L50 30 Z" fill="none" stroke="#334155" strokeWidth="4" />}
                </svg>
            </div>
        );

        // --- å®Œæ•´ 20 é¡Œé¡Œåº« (Updated with 4 options) ---
        const FULL_QUESTIONS = [
            { id: 1, title: 'é‹ç®—æ¬¡åº', text: '50 - (15 + 9) = ?', steps: [
                { type: 'LOGIC', text: 'æœ‰æ‹¬å¼§ï¼Œç¬¬ä¸€æ­¥å…ˆç®—ï¼Ÿ', options: ['50 - 15', '15 + 9', '50 + 9', '50 - 9'], ans: '15 + 9' },
                { type: 'ADD', n1: 15, n2: 9, hint: 'ç›´å¼è¨ˆç®— 15 + 9' },
                { type: 'SUB', n1: 50, n2: 24, hint: 'ç”¨ 50 æ¸›å»å‰›æ‰çš„ç­”æ¡ˆ' }
            ]},
            { id: 2, title: 'é‹ç®—æ¬¡åº', text: '6 Ã— (42 - 18) = ?', steps: [
                { type: 'LOGIC', text: 'æ‹¬å¼§å…§çš„æ¸›æ³•è¦å…ˆç®—ã€‚ç®—å¼æ˜¯ï¼Ÿ', options: ['6 Ã— 42', '42 - 18', '6 Ã— 18', '6 + 42'], ans: '42 - 18' },
                { type: 'SUB', n1: 42, n2: 18, hint: 'ç›´å¼è¨ˆç®—æ‹¬å¼§å…§' },
                { type: 'MULTI', n1: 24, n2: 6, hint: 'ç­”æ¡ˆ 24 å†ä¹˜ä»¥ 6' }
            ]},
            { id: 3, title: 'é‹ç®—æ¬¡åº', text: '12 + 5 Ã— 6 = ?', steps: [
                { type: 'LOGIC', text: 'æ²’æœ‰æ‹¬å¼§ï¼Œè¦å…ˆä¹˜é™¤å¾ŒåŠ æ¸›ã€‚ç¬¬ä¸€æ­¥ï¼Ÿ', options: ['12 + 5', '5 Ã— 6', '12 + 6', '12 - 5'], ans: '5 Ã— 6' },
                { type: 'INPUT_CHECK', label: 'å¿ƒç®— 5 Ã— 6 = ?', correct: '30' },
                { type: 'ADD', n1: 12, n2: 30, hint: 'æœ€å¾Œç®— 12 åŠ  30' }
            ]},
            { id: 4, title: 'é€£çºŒæ¸›æ³•', text: '500 - 128 - 75 = ?', steps: [
                { type: 'LOGIC', text: 'æ²’æœ‰æ‹¬å¼§ï¼Œå¾å·¦åˆ°å³ç®—ã€‚ç¬¬ä¸€æ­¥ï¼Ÿ', options: ['500 - 128', '128 - 75', '500 - 75', '128 + 75'], ans: '500 - 128' },
                { type: 'SUB', n1: 500, n2: 128, hint: 'ç›´å¼è¨ˆç®— 500 - 128' },
                { type: 'SUB', n1: 372, n2: 75, hint: 'å†æ¸›å» 75' }
            ]},
            { id: 5, title: 'æ··åˆæ‡‰ç”¨', text: '8 Ã— (37 - 11) = ?', steps: [
                { type: 'LOGIC', text: 'å…ˆç®—æ‹¬å¼§ã€‚ç®—å¼æ˜¯ï¼Ÿ', options: ['37 - 11', '8 Ã— 37', '8 + 37', '8 - 11'], ans: '37 - 11' },
                { type: 'SUB', n1: 37, n2: 11, hint: 'è¨ˆç®—æ‹¬å¼§å…§' },
                { type: 'MULTI', n1: 26, n2: 8, hint: 'ç”¨ 26 ä¹˜ä»¥ 8' }
            ]},
            { id: 6, title: 'å››ä½æ•¸é€²ä½', text: '2456 + 3789 = ?', steps: [
                { type: 'LOGIC', text: 'é€™æ˜¯ç´”åŠ æ³•ï¼Œè«‹ç›´æ¥ç”¨ç›´å¼ã€‚', options: ['é–‹å§‹è¨ˆç®—', 'è·³é', 'å¿ƒç®—', 'æ”¾æ£„'], ans: 'é–‹å§‹è¨ˆç®—' },
                { type: 'ADD', n1: 2456, n2: 3789, hint: 'å°å¿ƒé€£çºŒé€²ä½' }
            ]},
            { id: 7, title: 'å››ä½æ•¸å€Ÿä½', text: '4000 - 1234 = ?', steps: [
                { type: 'LOGIC', text: 'è¢«æ¸›æ•¸æœ‰å¾ˆå¤š 0ï¼Œè¦ç‰¹åˆ¥å°å¿ƒï¼', options: ['é–‹å§‹è¨ˆç®—', 'ç”¨åŠ æ³•', 'ä¸ç”¨ç®—', 'å¿ƒç®—'], ans: 'é–‹å§‹è¨ˆç®—' },
                { type: 'SUB', n1: 4000, n2: 1234, hint: '0 ä¸å¤ æ¸›ï¼Œå‘å·¦å€Ÿä½' }
            ]},
            { id: 8, title: 'é€£çºŒæ··åˆ', text: '1250 + 850 - 600 = ?', steps: [
                { type: 'LOGIC', text: 'å…ˆåŠ å¾Œæ¸›ã€‚ç¬¬ä¸€æ­¥ï¼Ÿ', options: ['1250 + 850', '850 - 600', '1250 - 600', '1250 + 600'], ans: '1250 + 850' },
                { type: 'ADD', n1: 1250, n2: 850, hint: 'è¨ˆç®—åŠ æ³•' },
                { type: 'SUB', n1: 2100, n2: 600, hint: 'å†æ¸›å» 600' }
            ]},
            { id: 9, title: '24å°æ™‚åˆ¶', text: 'ä¸‹åˆ 9:20 ç”¨ 24 å°æ™‚åˆ¶è¡¨ç¤ºã€‚', steps: [
                { type: 'LOGIC', text: 'ä¸‹åˆ (PM) çš„å°æ™‚è¦æ€éº¼è¾¦ï¼Ÿ', options: ['åŠ  12', 'æ¸› 12', 'ä¸è®Š', 'åŠ  10'], ans: 'åŠ  12' },
                { type: 'INPUT_CHECK', label: '9 + 12 = ?', correct: '21' },
                { type: 'INPUT_CHECK', label: 'å®Œæ•´æ™‚é–“ (å¦‚ 21:20)', correct: '21:20' }
            ]},
            { id: 10, title: '24å°æ™‚åˆ¶', text: '15:45 æ˜¯ä¸Šåˆé‚„æ˜¯ä¸‹åˆï¼Ÿ', steps: [
                { type: 'LOGIC', text: '15 å¤§æ–¼ 12ï¼Œæ‰€ä»¥æ˜¯ï¼Ÿ', options: ['ä¸‹åˆ (PM)', 'ä¸Šåˆ (AM)', 'ä¸­åˆ', 'å‡Œæ™¨'], ans: 'ä¸‹åˆ (PM)' },
                { type: 'INPUT_CHECK', label: '15 - 12 = ?', correct: '3' },
                { type: 'INPUT_CHECK', label: 'å®Œæ•´å¯«æ³• (å¦‚ 3:45pm)', correct: '3:45pm' }
            ]},
            { id: 11, title: 'æ™‚é–“æ¨ç®—', text: 'ç¾åœ¨ 14:00ï¼Œå…©å°æ™‚åŠå¾Œæ˜¯å¹¾é»ï¼Ÿ', steps: [
                { type: 'LOGIC', text: '14:00 + 2å°æ™‚ = ?', options: ['16:00', '15:30', '14:30', '17:00'], ans: '16:00' },
                { type: 'CLOCK_INTERACTIVE', startH: 14, startM: 0, targetH: 16, targetM: 30, hint: 'è«‹èª¿æ•´æ™‚é˜é¡¯ç¤º 16:30' }
            ]},
            { id: 12, title: 'åœ–å½¢èˆ‡è§’', isGeometry: true, geoType: 'trapezoid', text: 'è§€å¯Ÿæ¢¯å½¢å…§çš„ä¸‰è§’å½¢ã€‚', steps: [
                { type: 'LOGIC', text: 'ä¸‰è§’å½¢å…§æœ‰å¹¾å€‹éŠ³è§’ï¼Ÿ', options: ['3å€‹', '2å€‹', '1å€‹', '0å€‹'], ans: '3å€‹' },
                { type: 'LOGIC', text: 'æ¢¯å½¢(ä¸å«ä¸‰è§’å½¢)æœ‰å¹¾å€‹éˆè§’ï¼Ÿ', options: ['2å€‹', '1å€‹', '3å€‹', '0å€‹'], ans: '2å€‹' }
            ]},
            { id: 13, title: 'è¾¨åˆ¥ç›´è§’', isGeometry: true, geoType: 'triangle', text: 'é€™æ˜¯ä¸€å€‹ç›´è§’ä¸‰è§’å½¢ã€‚', steps: [
                { type: 'LOGIC', text: 'åœ–ä¸­æœ‰å¤šå°‘å€‹ç›´è§’ï¼Ÿ', options: ['1å€‹', '0å€‹', '2å€‹', '3å€‹'], ans: '1å€‹' },
                { type: 'LOGIC', text: 'æœ€å¤§çš„é‚£å€‹è§’æ˜¯ï¼Ÿ', options: ['ç›´è§’', 'éŠ³è§’', 'éˆè§’', 'å¹³è§’'], ans: 'ç›´è§’' }
            ]},
            { id: 14, title: 'è§’çš„å¤§å°', text: 'éˆè§’å’Œç›´è§’ï¼Œå“ªå€‹æ¯”è¼ƒå¤§ï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'ç›´è§’æ˜¯90åº¦ï¼Œéˆè§’å¤§æ–¼90åº¦ã€‚æ‰€ä»¥ï¼Ÿ', options: ['éˆè§’è¼ƒå¤§', 'ç›´è§’è¼ƒå¤§', 'ä¸€æ¨£å¤§', 'ç„¡æ³•æ¯”è¼ƒ'], ans: 'éˆè§’è¼ƒå¤§' },
                { type: 'LOGIC', text: 'éŠ³è§’å’Œç›´è§’ï¼Œå“ªå€‹æ¯”è¼ƒç´°ï¼Ÿ', options: ['éŠ³è§’', 'ç›´è§’', 'éˆè§’', 'ä¸€æ¨£ç´°'], ans: 'éŠ³è§’' }
            ]},
            { id: 15, title: 'å€æ•¸æ–‡å­—é¡Œ', text: 'å¦¹å¦¹æœ‰ $15ï¼Œå§å§çš„éŒ¢æ˜¯å¦¹å¦¹çš„ 5 å€ã€‚å§å§æœ‰å¤šå°‘éŒ¢ï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'ã€Œ5 å€ã€è¡¨ç¤ºè¦ç”¨ä»€éº¼é‹ç®—ï¼Ÿ', options: ['ä¹˜æ³•', 'åŠ æ³•', 'æ¸›æ³•', 'é™¤æ³•'], ans: 'ä¹˜æ³•' },
                { type: 'MULTI', n1: 15, n2: 5, hint: 'ç›´å¼è¨ˆç®— 15 Ã— 5' }
            ]},
            { id: 16, title: 'æ‰¾è´–æ–‡å­—é¡Œ', text: 'æˆ‘æœ‰ $100ï¼Œè²·äº† 4 æœ¬ $22 çš„æ›¸ï¼Œé‚„å‰©å¤šå°‘éŒ¢ï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'Step 1: å…ˆç®— 4 æœ¬æ›¸ç¸½åƒ¹', options: ['22 Ã— 4', '100 - 22', '22 + 4', '100 Ã· 4'], ans: '22 Ã— 4' },
                { type: 'MULTI', n1: 22, n2: 4, hint: 'è¨ˆç®—ç¸½åƒ¹' },
                { type: 'LOGIC', text: 'Step 2: ç”¨ $100 æ¸›å»ç¸½åƒ¹ $88', options: ['100 - 88', '88 - 100', '100 + 88', '88 Ã— 100'], ans: '100 - 88' },
                { type: 'SUB', n1: 100, n2: 88, hint: 'è¨ˆç®—æ‰¾è´–' }
            ]},
            { id: 17, title: 'æ¯”è¼ƒæ–‡å­—é¡Œ', text: 'æ›¸ A å”® $45ï¼Œæ›¸ B æ¯”æ›¸ A ä¾¿å®œ $12ã€‚è²·æ›¸ B è¦ä»˜å¤šå°‘éŒ¢ï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'ä¾¿å®œ $12 ä»£è¡¨æ›¸ B åƒ¹éŒ¢è¼ƒå°‘ã€‚', options: ['45 - 12', '45 + 12', '45 Ã— 12', '12 - 45'], ans: '45 - 12' },
                { type: 'SUB', n1: 45, n2: 12, hint: 'è¨ˆç®—æ›¸ B çš„åƒ¹éŒ¢' }
            ]},
            { id: 18, title: 'å…©æ­¥æ–‡å­—é¡Œ', text: 'åº—è£¡æœ‰ 500 å€‹è˜‹æœï¼Œä¸Šåˆè³£äº† 120 å€‹ï¼Œä¸‹åˆè³£äº† 150 å€‹ã€‚é‚„å‰©å¤šå°‘å€‹ï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'å…ˆç®—ç¸½å…±è³£äº†å¤šå°‘å€‹ã€‚', options: ['120 + 150', '500 - 120', '500 - 150', '150 - 120'], ans: '120 + 150' },
                { type: 'ADD', n1: 120, n2: 150, hint: 'è¨ˆç®—è³£å‡ºçš„ç¸½æ•¸' },
                { type: 'SUB', n1: 500, n2: 270, hint: 'ç”¨åŸæœ¬æ•¸é‡æ¸›å»è³£å‡ºçš„' }
            ]},
            { id: 19, title: 'æ¯äººä»˜æ¬¾', text: '3 å€‹åŒå­¸å»é‡é¤ï¼Œæ¯äººè¦ä»˜ $35ã€‚ä»–å€‘å…±ä»˜äº†å¤šå°‘å…ƒï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'ã€Œæ¯äººã€ä»˜ $35ï¼Œå…±æœ‰ 3 äººã€‚', options: ['35 Ã— 3', '35 + 3', '35 - 3', '35 Ã· 3'], ans: '35 Ã— 3' },
                { type: 'MULTI', n1: 35, n2: 3, hint: 'ç›´å¼è¨ˆç®—ç¸½é‡‘é¡' }
            ]},
            { id: 20, title: 'åˆè³‡æ–‡å­—é¡Œ', text: 'å“¥å“¥æœ‰ 20 å…ƒï¼Œå¼Ÿå¼Ÿæœ‰ 10 å…ƒã€‚è²·ä¸€å€‹ $45 çš„ç©å…·ï¼Œä»–å€‘åˆè³‡é‚„æ¬ å¤šå°‘ï¼Ÿ', steps: [
                { type: 'LOGIC', text: 'Step 1: å…ˆç®—å…©äººå…±æœ‰å¤šå°‘éŒ¢', options: ['20 + 10', '20 - 10', '20 Ã— 10', '45 - 20'], ans: '20 + 10' },
                { type: 'INPUT_CHECK', label: '20 + 10 = ?', correct: '30' },
                { type: 'LOGIC', text: 'Step 2: ç©å…· $45ï¼Œä»–å€‘æœ‰ $30ï¼Œæ¬ å¤šå°‘ï¼Ÿ', options: ['45 - 30', '30 + 45', '45 + 30', '30 - 45'], ans: '45 - 30' },
                { type: 'SUB', n1: 45, n2: 30, hint: 'è¨ˆç®—å·®é¡' }
            ]}
        ];

        const App = () => {
            const [mode, setMode] = useState('MENU');
            const [qIndex, setQIndex] = useState(0);
            const [stepIndex, setStepIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [mistakeList, setMistakeList] = useState(new Set()); // å­˜å„²éŒ¯é¡Œ ID
            const [timer, setTimer] = useState(0);
            const [clockState, setClockState] = useState({h: 12, m: 0});
            const [praise, setPraise] = useState('');
            
            // æ±ºå®šç•¶å‰è¦é¡¯ç¤ºçš„é¡Œç›®åˆ—è¡¨ (æ­£å¸¸æ¨¡å¼ vs é‡åšæ¨¡å¼)
            const [activeQuestions, setActiveQuestions] = useState(FULL_QUESTIONS);

            const timerRef = useRef(null);

            const currentQ = activeQuestions[qIndex];
            const currentStep = currentQ.steps[stepIndex];
            const progress = ((qIndex) / activeQuestions.length) * 100;

            useEffect(() => {
                if (mode === 'GAME') {
                    timerRef.current = setInterval(() => setTimer(t => t + 1), 1000);
                } else clearInterval(timerRef.current);
                return () => clearInterval(timerRef.current);
            }, [mode]);

            useEffect(() => {
                if (mode === 'GAME' && currentStep.type === 'CLOCK_INTERACTIVE') {
                    setClockState({ h: currentStep.startH || 12, m: currentStep.startM || 0 });
                }
            }, [qIndex, stepIndex, mode, activeQuestions]);

            const showPraise = () => {
                const msg = PRAISE_WORDS[Math.floor(Math.random() * PRAISE_WORDS.length)];
                setPraise(msg);
                setTimeout(() => setPraise(''), 1500);
            };

            const markMistake = () => {
                // å°‡ç•¶å‰é¡Œç›® ID åŠ å…¥éŒ¯é¡Œé›†
                setMistakeList(prev => {
                    const newSet = new Set(prev);
                    newSet.add(currentQ.id);
                    return newSet;
                });
            };

            const handleLogicChoice = (opt) => {
                if (opt === currentStep.ans) {
                    showPraise();
                    nextStep();
                } else {
                    markMistake();
                    alert(`é¸éŒ¯äº†ï¼${opt} ä¸æ­£ç¢ºï¼Œå†è©¦ä¸€æ¬¡ï¼`);
                }
            };

            const handleCalcComplete = (val) => {
                showPraise();
                nextStep();
            };

            const handleInputCheck = (val) => {
                if (val.trim() === currentStep.correct) {
                    showPraise();
                    nextStep();
                } else {
                    markMistake();
                    alert(`ç­”æ¡ˆä¸å°å–”ï¼`);
                }
            };

            const handleTimeUpdate = (newH, newM) => setClockState({h: newH, m: newM});

            const handleClockConfirm = () => {
                let targetH = currentStep.targetH;
                let h = clockState.h;
                let m = clockState.m;
                let isCorrect = false;
                if (m === currentStep.targetM) {
                    if (h === targetH) isCorrect = true;
                    if (h > 12 && h - 12 === targetH) isCorrect = true; 
                    if (targetH > 12 && h === targetH - 12) isCorrect = true;
                }

                if (isCorrect) {
                    showPraise();
                    nextStep();
                } else {
                    markMistake();
                    alert(`æ™‚é–“ä¸å°ï¼Œè«‹å†èª¿ä¸€æ¬¡ï¼`);
                }
            };

            const nextStep = () => {
                if (stepIndex < currentQ.steps.length - 1) {
                    setStepIndex(p => p + 1);
                } else {
                    // å®Œæˆä¸€é¡Œ
                    if (qIndex < activeQuestions.length - 1) {
                        setQIndex(q => q + 1);
                        setStepIndex(0);
                    } else {
                        setMode('RESULT');
                    }
                }
            };

            const startRedo = () => {
                // éæ¿¾å‡ºéŒ¯é¡Œ
                const wrongQs = FULL_QUESTIONS.filter(q => mistakeList.has(q.id));
                setActiveQuestions(wrongQs);
                setQIndex(0);
                setStepIndex(0);
                setMode('GAME');
                // é€™è£¡ä¸æ¸…é™¤ mistakeListï¼Œç›´åˆ°ä»–åšå°ç‚ºæ­¢ (æˆ–è€…ä½ å¯ä»¥é¸æ“‡æ¸…é™¤)
                // ç‚ºäº†é‚è¼¯ç°¡å–®ï¼Œæˆ‘å€‘å‡è¨­é‡åšæ™‚å¦‚æœå°äº†å°±ä¸å†æ˜¯éŒ¯é¡Œï¼Œä½†é€™è£¡ç°¡åŒ–ç‚ºé‡æ–°è·‘ä¸€æ¬¡éŒ¯é¡Œæµç¨‹
            };

            const resetAll = () => {
                setActiveQuestions(FULL_QUESTIONS);
                setQIndex(0);
                setStepIndex(0);
                setScore(0);
                setMistakeList(new Set());
                setTimer(0);
                setMode('MENU');
            };

            const renderStep = () => {
                const stepKey = `${currentQ.id}-${stepIndex}`; 
                switch(currentStep.type) {
                    case 'LOGIC':
                        return (
                            <div key={stepKey} className="grid gap-4 animate-in slide-in-from-right">
                                <div className="bg-indigo-50 p-4 rounded-xl text-indigo-800 font-bold flex gap-2"><Icon.Brain/> {currentStep.text}</div>
                                {currentStep.options.map((o, i) => (
                                    <button key={i} onClick={() => handleLogicChoice(o)} className="p-4 border-2 border-slate-200 rounded-xl font-bold hover:bg-indigo-100 hover:border-indigo-400 active:scale-95 transition-all text-left">{o}</button>
                                ))}
                            </div>
                        );
                    case 'ADD':
                    case 'SUB':
                        return (
                            <div key={stepKey} className="animate-in zoom-in-95">
                                <div className="bg-emerald-50 p-3 rounded-xl text-emerald-800 font-bold mb-4 text-center text-sm"><Icon.Calc/> {currentStep.hint}</div>
                                <VerticalAddSub n1={currentStep.n1} n2={currentStep.n2} op={currentStep.type==='ADD'?'+':'-'} onComplete={handleCalcComplete} />
                            </div>
                        );
                    case 'MULTI':
                        return (
                            <div key={stepKey} className="animate-in zoom-in-95">
                                <div className="bg-emerald-50 p-3 rounded-xl text-emerald-800 font-bold mb-4 text-center text-sm"><Icon.Calc/> {currentStep.hint}</div>
                                <VerticalMulti n1={currentStep.n1} n2={currentStep.n2} onComplete={handleCalcComplete} />
                            </div>
                        );
                    case 'INPUT_CHECK':
                        return (
                            <div key={stepKey} className="flex flex-col gap-4 animate-in slide-in-from-right">
                                <label className="font-bold text-slate-700">{currentStep.label}</label>
                                <input type="text" className="p-4 border-2 border-slate-300 rounded-xl text-center text-2xl font-black" placeholder="è¼¸å…¥ç­”æ¡ˆ" onKeyDown={(e)=>{if(e.key==='Enter') handleInputCheck(e.target.value)}} />
                                <button className="bg-slate-800 text-white p-4 rounded-xl font-black" onClick={(e)=>handleInputCheck(e.target.previousSibling.value)}>ç¢ºå®š</button>
                            </div>
                        );
                    case 'CLOCK_INTERACTIVE':
                        return (
                            <div key={stepKey} className="animate-in zoom-in-95">
                                <div className="bg-yellow-50 p-3 rounded-xl text-yellow-800 font-bold mb-4 text-center text-sm"><Icon.Clock/> {currentStep.hint}</div>
                                <ClockFace h={clockState.h} m={clockState.m} interactive={true} onTimeChange={handleTimeUpdate} onConfirm={handleClockConfirm}/>
                            </div>
                        );
                    default: return null;
                }
            };

            if (mode === 'MENU') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-[2.5rem] p-8 md:p-12 max-w-lg w-full shadow-2xl text-center border border-slate-100">
                        <div className="inline-block p-4 bg-indigo-100 rounded-full text-indigo-600 mb-6"><Icon.Brain/></div>
                        <h1 className="text-3xl font-black text-slate-800 mb-2">Jasper æ•¸å­¸æ¨¡æ“¬è©¦å·</h1>
                        <p className="text-indigo-500 font-bold mb-8 uppercase tracking-widest">V5.0 é€²éšå›é¥‹ç‰ˆ</p>
                        <div className="text-left bg-slate-50 p-6 rounded-2xl mb-8 space-y-3 text-slate-600 font-bold text-sm">
                            <div className="flex items-center gap-3"><span className="w-2 h-2 rounded-full bg-indigo-500"></span> 20 é¡Œå®Œæ•´æ¸¬è©¦</div>
                            <div className="flex items-center gap-3"><span className="w-2 h-2 rounded-full bg-indigo-500"></span> 4 é¸ 1 æŒ‘æˆ°</div>
                            <div className="flex items-center gap-3"><span className="w-2 h-2 rounded-full bg-indigo-500"></span> å³æ™‚é¼“å‹µèˆ‡å›é¥‹</div>
                            <div className="flex items-center gap-3"><span className="w-2 h-2 rounded-full bg-indigo-500"></span> éŒ¯é¡Œé‡åšåŠŸèƒ½</div>
                        </div>
                        <button onClick={() => { setActiveQuestions(FULL_QUESTIONS); setMode('GAME'); setScore(0); setMistakeList(new Set()); setQIndex(0); setStepIndex(0); }} className="w-full bg-indigo-600 text-white text-xl font-black py-5 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all">é–‹å§‹æŒ‘æˆ°</button>
                    </div>
                </div>
            );

            if (mode === 'RESULT') {
                const totalQ = activeQuestions.length;
                const wrongCount = mistakeList.size; 
                // æ³¨æ„ï¼šé€™è£¡çš„éŒ¯é¡Œæ•¸æ˜¯åŸºæ–¼ç´¯ç©çš„ mistakeListï¼Œå¦‚æœæ˜¯é‡åšæ¨¡å¼ï¼Œé€™è£¡é¡¯ç¤ºçš„å¯èƒ½éœ€è¦èª¿æ•´é‚è¼¯
                // ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘é¡¯ç¤º "é€™æ¬¡ç·´ç¿’çš„çµæœ"
                
                const isPerfect = wrongCount === 0;

                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl text-center border border-slate-100 animate-in zoom-in-95">
                            <h2 className="text-4xl font-black text-slate-800 mb-6">ç·´ç¿’çµæŸï¼</h2>
                            
                            {isPerfect ? (
                                <div className="bg-green-50 p-8 rounded-3xl text-green-700 font-bold mb-8 border border-green-200 text-lg flex flex-col items-center gap-2">
                                    <Icon.Star /> å¤ªæ£’äº†ï¼å…¨éƒ¨ç­”å°ï¼<br/><span className="text-sm font-normal">Jasper ä½ æ˜¯æ•¸å­¸å°å¤©æ‰ï¼</span>
                                </div>
                            ) : (
                                <div className="bg-rose-50 p-6 rounded-3xl mb-8 border border-rose-100">
                                    <h3 className="font-bold text-rose-600 mb-2 text-lg">é‚„æœ‰ {wrongCount} é¡Œéœ€è¦è¤‡ç¿’ ğŸ’ª</h3>
                                    <p className="text-slate-600 text-sm">åˆ¥ç°å¿ƒï¼Œé‡åšä¸€æ¬¡å°±æœƒäº†ï¼</p>
                                </div>
                            )}

                            <div className="flex flex-col gap-4">
                                {!isPerfect && (
                                    <button onClick={startRedo} className="w-full bg-rose-500 text-white text-xl font-black py-4 rounded-2xl shadow-xl shadow-rose-200 hover:bg-rose-600 active:scale-95 transition-all flex items-center justify-center gap-2">
                                        <Icon.Redo /> é‡åšéŒ¯é¡Œ
                                    </button>
                                )}
                                <button onClick={resetAll} className="w-full bg-slate-800 text-white text-xl font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all">è¿”å›ä¸»é¸å–®</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-2xl mx-auto relative overflow-hidden">
                    {/* é¼“å‹µå‹•ç•«å±¤ */}
                    {praise && (
                        <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                            <div className="praise-anim bg-yellow-400 text-yellow-900 px-8 py-4 rounded-3xl text-4xl font-black shadow-2xl border-4 border-white transform rotate-[-5deg]">
                                {praise}
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3 px-5 py-3 bg-white rounded-2xl font-bold text-slate-600 shadow-sm border border-slate-100">
                             <span className="text-xs uppercase text-slate-400">Q</span>
                             <span className="text-xl text-slate-800">{qIndex + 1} <span className="text-slate-300">/</span> {activeQuestions.length}</span>
                        </div>
                         <div className="flex items-center gap-3 px-5 py-3 bg-white rounded-2xl font-bold text-indigo-600 shadow-sm border border-slate-100">
                             <Icon.Clock/> <span className="text-xl font-mono">{Math.floor(timer/60)}:{timer%60 < 10 ? '0'+timer%60 : timer%60}</span>
                        </div>
                    </div>

                    <div className="w-full bg-slate-200 h-2 rounded-full mb-6 overflow-hidden">
                        <div className="bg-indigo-500 h-full transition-all duration-500" style={{width: `${progress}%`}}></div>
                    </div>

                    <div className="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden relative">
                        <div className="bg-slate-50 p-8 border-b border-slate-100 text-center relative">
                            <div className="inline-block px-3 py-1 rounded-full bg-indigo-100 text-indigo-600 text-xs font-black uppercase tracking-widest mb-3">{currentQ.title}</div>
                            <h2 className="text-3xl font-black text-slate-800 leading-snug">{currentQ.text}</h2>
                            {currentQ.isGeometry && <GeometryView type={currentQ.geoType} />}
                        </div>
                        
                        <div className="p-8 min-h-[350px] flex flex-col">
                            <div className="text-center text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest flex items-center justify-center gap-2">
                                Step {stepIndex + 1} of {currentQ.steps.length}
                            </div>
                            {renderStep()}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
